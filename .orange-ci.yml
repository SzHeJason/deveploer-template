# === !!! DON'T EDIT THIS FILE !!! ===
# === GENERATED BY @tencent/ocg ===
# === (config from: scripts/ci/index.ts) ===

develop:
  merge_request:
    - runner:
        network: devnet
      stages:
        - name: 构建缓存镜像
          jobs:
            - name: docker cache
              type: 'docker:cache'
              exports:
                name: DOCKER_CACHE_IMAGE_NAME
              options:
                versionBy:
                  - yarn.lock
                dockerfile: cache.dockerfile
                by:
                  - yarn.lock
                  - package.json
        - name: 检查代码
          jobs:
            - name: use docker cache
              image: $DOCKER_CACHE_IMAGE_NAME
              commands:
                - cp -an $CACHE_PATH/node_modules ./node_modules
                - npm run check
  review:
    - stages:
        - name: Review 后自动合并
          jobs:
            - name: automerge
              type: 'git:automerge'
              options:
                mergeType: merge
  push:
    - runner:
        network: devnet
      git:
        dotGit: true
      services:
        - ssh-agent-for-oa
      stages:
        - name: 打印信息
          jobs:
            - name: info
              script:
                - echo $(git config --global --get user.name)
                - echo $ORANGE_BUILD_USER
        - name: 配置 Git 环境，增加读可权限
          jobs:
            - name: config
              imports:
                - 'https://git.woa.com/wesing-web/secret-park/blob/master/git.yml'
              script:
                - 'ssh-add -D '
                - 'echo -n "${GIT_SSH_KEY}" > ~/.ssh/id_rsa'
                - chmod 0600 ~/.ssh/id_rsa
                - git config --global user.email "$GIT_EMAIL"
                - git config --global user.name "$GIT_USER_NAME"
        - name: 检查是否继续流程
          jobs:
            - name: check
              if:
                - >-
                  test $(git config --global --get user.name) =
                  $ORANGE_BUILD_USER
              script:
                - exit 78
        - name: 下载部分依赖
          jobs:
            - name: install node module
              script:
                - yarn global add standard-version
        - name: 标准化发布流程
          jobs:
            - name: 执行 standard-version
              script:
                - git fetch --all
                - git checkout -b $ORANGE_BRANCH origin/$ORANGE_BRANCH
                - >-
                  standard-version --skip.changelog=true --release-as patch
                  --prerelease beta
                - git push --follow-tags origin $ORANGE_BRANCH
master:
  merge_request:
    - runner:
        network: devnet
      stages:
        - name: 构建缓存镜像
          jobs:
            - name: docker cache
              type: 'docker:cache'
              exports:
                name: DOCKER_CACHE_IMAGE_NAME
              options:
                versionBy:
                  - yarn.lock
                dockerfile: cache.dockerfile
                by:
                  - yarn.lock
                  - package.json
        - name: 检查代码
          jobs:
            - name: use docker cache
              image: $DOCKER_CACHE_IMAGE_NAME
              commands:
                - cp -an $CACHE_PATH/node_modules ./node_modules
                - npm run check
  review:
    - stages:
        - name: Review 后自动合并
          jobs:
            - name: automerge
              type: 'git:automerge'
              options:
                mergeType: merge
  push:
    - runner:
        network: devnet
      git:
        dotGit: true
      services:
        - ssh-agent-for-oa
      stages:
        - name: 打印信息
          jobs:
            - name: info
              script:
                - echo $(git config --global --get user.name)
                - echo $ORANGE_BUILD_USER
        - name: 配置 Git 环境，增加读可权限
          jobs:
            - name: config
              imports:
                - 'https://git.woa.com/wesing-web/secret-park/blob/master/git.yml'
              script:
                - 'ssh-add -D '
                - 'echo -n "${GIT_SSH_KEY}" > ~/.ssh/id_rsa'
                - chmod 0600 ~/.ssh/id_rsa
                - git config --global user.email "$GIT_EMAIL"
                - git config --global user.name "$GIT_USER_NAME"
        - name: 检查是否继续流程
          jobs:
            - name: check
              if:
                - >-
                  test $(git config --global --get user.name) =
                  $ORANGE_BUILD_USER
              script:
                - exit 78
        - name: 下载部分依赖
          jobs:
            - name: install node module
              script:
                - yarn global add standard-version
        - name: 标准化发布流程
          jobs:
            - name: 执行 standard-version
              script:
                - git fetch --all
                - git checkout -b $ORANGE_BRANCH origin/$ORANGE_BRANCH
                - standard-version --release-as patch
                - git push --follow-tags origin $ORANGE_BRANCH
        - name: 获取 npm 版本
          jobs:
            - name: Pick Npm Version
              exports:
                stdout: NPM_VERSION
              script:
                - >-
                  cat package.json | grep version | head -1 | awk -F: '{ print
                  $2 }' | sed 's/[",]//g' | tr -d '[[:space:]]'
        - name: 创建 Release 分支
          jobs:
            - name: release
              script:
                - git fetch --all
                - git checkout -b release/v$NPM_VERSION origin/$ORANGE_BRANCH
                - git push --set-upstream origin release/v$NPM_VERSION
                - git checkout -b develop origin/develop
                - git merge --squash release/v$NPM_VERSION --no-edit || true
                - git checkout --theirs package.json CHANGELOG.md || true
                - git add . || true
                - git commit --no-edit || true
                - git push


# === !!! DON'T EDIT THIS FILE !!! ===
# === GENERATED BY @tencent/ocg ===
# === (config from: scripts/ci/index.ts) ===